<?xml version="1.0"?>
<ESPublicQuery xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <SQL><![CDATA[WITH cte AS (
    SELECT 
        MAX(ESFIDocumentTrade.ADRegistrationDate) AS ADRegistrationDate
    FROM 
        ESFIDocumentTrade
        LEFT JOIN ESFIDocumentType AS FK_ESFIDocumentTrade_ESFIDocumentType
            ON ESFIDocumentTrade.fADDocumentTypeGID = FK_ESFIDocumentTrade_ESFIDocumentType.GID 
    WHERE 
        ESFIDocumentTrade.fCompanyCode = ##(ESCOMPANY)
        AND FK_ESFIDocumentTrade_ESFIDocumentType.MenuEntry = 34
        AND FK_ESFIDocumentTrade_ESFIDocumentType.InternationalID = 'ES.10000.01'
		AND fTransitionStepCode='INITIAL'
        AND ESFIDocumentTrade.fTradeAccountGID = (
            SELECT dbo.GetTradeAccountGID(##(ESUSER),##(ESCOMPANY),##(ESBRANCH))
        )
        AND ESFIDocumentTrade.fDeliverySiteGID = (
            SELECT TOP 1 ESGOSites.GID 
            FROM ESGOSites 
            INNER JOIN ESGOPerson ON ESGOSites.fPersonCodeGID = ESGOPerson.GID
            INNER JOIN ESFITradeAccount ON ESGOPerson.GID = ESFITradeAccount.fPersonCodeGID
            WHERE ESFITradeAccount.GID = dbo.GetTradeAccountGID(##(ESUSER),##(ESCOMPANY),##(ESBRANCH))
        
        AND ESGOSites.Code = isnull((
            SELECT TOP 1 StringField1 
            FROM ESGOUser 
            WHERE userid = ##(ESUSER)
        ),ESGOSites.Code)
		
		
		)
), 
ES00list AS (
    SELECT TOP 1 ISNULL(MAX(DATEDIFF(DAY, ADRegistrationDate, GETDATE())), 0) AS ADRegistrationDate 
    FROM cte 
    WHERE DATEDIFF(DAY, ADRegistrationDate, GETDATE()) > 10
)
SELECT ADRegistrationDate AS ADRegistrationDate
FROM ES00List AS ES00List 
]]></SQL>
  <SQLforPaging><![CDATA[]]></SQLforPaging>
  <Table>ES00List</Table>
  <Params />
</ESPublicQuery>