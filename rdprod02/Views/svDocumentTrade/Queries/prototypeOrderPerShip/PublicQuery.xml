<?xml version="1.0"?>
<ESPublicQuery xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
  <SQL><![CDATA[WITH cte as (
select 
d.Code as ItemCode
, d.StringField2 as Category
, d.StringField3 as SubCategory
, d.StringField4 as IMPACode
, d.StringField5 as WHOCode
, f.RefNo 
, d.StringField6 as GenericName
, d.DetailDescription as BrandName
, d.StringField7 as UnitType
, a.Quantity as RequiredQuantity
, 0 as NewQuantity
, d.StringField8 as TreatmentRequirement
, d.StringField9 as Recomemdeddoses
, b.fTradeAccountGID
, e.code as CustomerCode
, b.fTradeAccountSiteGID
, g.code as CustomerStoreCode
, a.fItemGID
,'' as Comments


from ESFILineItem a
inner join ESFIDocumentTrade b
on a.fDocumentGID=b.gid
inner join ESFIDocumentType c
on b.fADDocumentTypeGID=c.gid
inner join esfiitem d
on a.fItemGID=d.gid
inner join ESFITradeAccount e
on b.fTradeAccountGID=e.gid
inner join ESGOSites g
on b.fTradeAccountSiteGID=g.gid
left join
(

select b.fTradeAccountGID, e.code as CustomerCode, a.fItemGID, d.code as ItemCode 
, a.StringField1 as RefNo
from ESFILineItem a
inner join ESFIDocumentTrade b
on a.fDocumentGID=b.gid
inner join ESFIDocumentType c
on b.fADDocumentTypeGID=c.gid
inner join esfiitem d
on a.fItemGID=d.gid
inner join ESFITradeAccount e
on b.fTradeAccountGID=e.gid
where c.code=(select top 1 StringField1 from ESGOUser where userid=##(ESUSER))
and a.fcompanycode='es'
) f
on b.fTradeAccountGID=f.fTradeAccountGID
and a.fItemGID=f.fItemGID
where c.code='ΠΑΡ'
and a.fcompanycode='es'
and b.fTradeAccountGID = (select dbo.GetTradeAccountGID(##(ESUSER),##(ESCOMPANY),##(ESBRANCH)))
and ADRegistrationDate>'20240601'),
ESFILineItem as 
(select * from cte)
SELECT ItemCode AS ItemCode, 
       Category AS Category, 
       SubCategory AS SubCategory, 
       IMPACode AS IMPACode, 
       WHOCode AS WHOCode, 
       RefNo AS RefNo, 
       GenericName AS GenericName, 
       BrandName AS BrandName, 
       UnitType AS UnitType, 
       RequiredQuantity AS RequiredQuantity, 
       NewQuantity AS NewQuantity, 
       TreatmentRequirement AS TreatmentRequirement, 
       Recomemdeddoses AS Recomemdeddoses, 
       fItemGID AS fItemGID1, 
       Comments AS Comments
FROM ESFILineItem AS ESFILineItem 
]]></SQL>
  <SQLforPaging><![CDATA[]]></SQLforPaging>
  <Table>ESFILineItem</Table>
  <Params />
</ESPublicQuery>